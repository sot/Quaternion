
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quaternion.Quaternion &#8212; Quaternion 4.1 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">Quaternion</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">Quaternion 4.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Quaternion.Quaternion</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quaternion provides a class for manipulating quaternion objects.  This class provides:</span>

<span class="sd">  - convenient ways to deal with rotation representations (equatorial</span>
<span class="sd">    coordinates, matrix and quaternion):</span>

<span class="sd">    - a constructor to initialize from rotations in various representations,</span>
<span class="sd">    - conversion methods to the different representations.</span>

<span class="sd">  - methods to multiply and divide quaternions.</span>

<span class="sd">:Copyright: Smithsonian Astrophysical Observatory (2010)</span>
<span class="sd">:Authors: - Tom Aldcroft (aldcroft@cfa.harvard.edu)</span>
<span class="sd">          - Jean Connelly (jconnelly@cfa.harvard.edu)</span>
<span class="sd">          - Javier Gonzalez (javier.gonzalez@cfa.harvard.edu)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Copyright (c) 2010, Smithsonian Astrophysical Observatory</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">##</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># * Redistributions of source code must retain the above copyright</span>
<span class="c1"># notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright</span>
<span class="c1"># notice, this list of conditions and the following disclaimer in the</span>
<span class="c1"># documentation and/or other materials provided with the distribution.</span>
<span class="c1"># * Neither the name of the Smithsonian Astrophysical Observatory nor the</span>
<span class="c1"># names of its contributors may be used to endorse or promote products</span>
<span class="c1"># derived from this software without specific prior written permission.</span>
<span class="c1">##</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="c1"># ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c1"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER&gt; BE LIABLE FOR ANY</span>
<span class="c1"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c1"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="c1"># ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c1"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.shapes</span> <span class="kn">import</span> <span class="n">ShapedLikeNDArray</span>


<div class="viewcode-block" id="Quat"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat">[docs]</a><span class="k">class</span> <span class="nc">Quat</span><span class="p">(</span><span class="n">ShapedLikeNDArray</span><span class="p">):</span>
    <span class="c1"># None of the base class method functions are defined for quaternions.</span>
    <span class="c1"># These include things like min, max, round, all, etc. Calling these numpy</span>
    <span class="c1"># functions on Quat just goes to the numpy function, which may or may not</span>
    <span class="c1"># do something or else give an exception.</span>
    <span class="n">_METHOD_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quaternion class</span>

<span class="sd">    Example usage::</span>

<span class="sd">     &gt;&gt;&gt; from Quaternion import Quat</span>
<span class="sd">     &gt;&gt;&gt; quat = Quat(equatorial=(12,45,45))</span>
<span class="sd">     &gt;&gt;&gt; quat.ra, quat.dec, quat.roll</span>
<span class="sd">     (12, 45, 45)</span>
<span class="sd">     &gt;&gt;&gt; quat.q</span>
<span class="sd">     array([ 0.38857298, -0.3146602 ,  0.23486498,  0.8335697 ])</span>
<span class="sd">     &gt;&gt;&gt; q2 = Quat(q=quat.q)</span>
<span class="sd">     &gt;&gt;&gt; q2.ra</span>
<span class="sd">     12.0</span>

<span class="sd">    Multiplication and division operators are overloaded for the class to</span>
<span class="sd">    perform appropriate quaternion multiplication and division.</span>

<span class="sd">    Quaternion composition as a multiplication q = q1 * q2 is equivalent to</span>
<span class="sd">    applying the q2 transform followed by the q1 transform.  Another way to</span>
<span class="sd">    express this is::</span>

<span class="sd">      q = Quat(transform=q1.transform @ q2.transform)</span>

<span class="sd">    Example usage::</span>

<span class="sd">      &gt;&gt;&gt; q1 = Quat(equatorial=(20, 30, 0))</span>
<span class="sd">      &gt;&gt;&gt; q2 = Quat(equatorial=(0, 0, 40))</span>
<span class="sd">      &gt;&gt;&gt; (q1 * q2).equatorial</span>
<span class="sd">      array([20., 30., 40.])</span>

<span class="sd">    This example first rolls about X by 40 degrees, then rotates that rolled frame</span>
<span class="sd">    to RA=20 and Dec=30.  Doing the composition in the other order does a roll about</span>
<span class="sd">    (the original) X-axis of the (RA, Dec) = (20, 30) frame, yielding a non-intuitive</span>
<span class="sd">    though correct result::</span>

<span class="sd">      &gt;&gt;&gt; (q2 * q1).equatorial</span>
<span class="sd">      array([ 353.37684725,   34.98868888,   47.499696  ])</span>

<span class="sd">    Note that each step is as described in the section</span>
<span class="sd">    :ref:`Equatorial -&gt; Matrix &lt;equatorialmatrix&gt;`</span>

<span class="sd">      &gt;&gt;&gt; q1 = Quat(equatorial=(20, 0, 0))</span>
<span class="sd">      &gt;&gt;&gt; q2 = Quat(equatorial=(0, 30, 0))</span>
<span class="sd">      &gt;&gt;&gt; q3 = Quat(equatorial=(0, 0, 40))</span>
<span class="sd">      &gt;&gt;&gt; q1.transform, q2.transform, q3.transform</span>
<span class="sd">      (array([[ 0.93969262, -0.34202014,  0.        ],</span>
<span class="sd">              [ 0.34202014,  0.93969262, -0.        ],</span>
<span class="sd">              [ 0.        ,  0.        ,  1.        ]]),</span>
<span class="sd">       array([[ 0.8660254, -0.       , -0.5      ],</span>
<span class="sd">              [ 0.       ,  1.       , -0.       ],</span>
<span class="sd">              [ 0.5      ,  0.       ,  0.8660254]]),</span>
<span class="sd">       array([[ 1.        , -0.        ,  0.        ],</span>
<span class="sd">              [ 0.        ,  0.76604444, -0.64278761],</span>
<span class="sd">              [ 0.        ,  0.64278761,  0.76604444]]))</span>

<span class="sd">    Be aware that for Chandra operations the correct formalism for applying a</span>
<span class="sd">    delta quaternion ``dq`` to maneuver from ``q1`` to ``q2`` is::</span>

<span class="sd">      &gt;&gt;&gt; q2 = q1 * dq</span>
<span class="sd">      &gt;&gt;&gt; dq = q1.inv() * q2</span>

<span class="sd">    The quaternion returned by ``q1 / q2`` using the divide operator represents the</span>
<span class="sd">    delta quaternion in the INERTIAL FRAME, which is not what is used by the</span>
<span class="sd">    spacecraft to represent maneuvers.</span>

<span class="sd">    Instead use the ``dq`` method (or equivalently ``q1.inv() * q2``) for computing a</span>
<span class="sd">    delta quaternion to maneuver from ``q1`` to ``q2``::</span>

<span class="sd">      &gt;&gt;&gt; dq = q1.dq(q2)</span>

<span class="sd">    When dealing with a collection of quaternions, it is much faster to operate</span>
<span class="sd">    on all of them at a time::</span>

<span class="sd">      &gt;&gt;&gt; eq1 = [[ 30.000008,  39.999999,  49.999995],</span>
<span class="sd">      ...        [ 30.000016,  39.999999,  49.99999 ],</span>
<span class="sd">      ...        [ 30.000024,  39.999998,  49.999984],</span>
<span class="sd">      ...        [ 30.000032,  39.999998,  49.999979],</span>
<span class="sd">      ...        [ 30.00004 ,  39.999997,  49.999974]])</span>
<span class="sd">      &gt;&gt;&gt; eq2 = [[ 34.679189,  42.454957,  43.647651],</span>
<span class="sd">      ...        [ 26.457503,  58.05772 ,  70.638782],</span>
<span class="sd">      ...        [ 42.283086,  50.072731,  36.676534],</span>
<span class="sd">      ...        [ 27.138448,  31.389365,  34.429049],</span>
<span class="sd">      ...        [ 22.722112,  37.893094,  50.06074 ]]</span>
<span class="sd">      &gt;&gt;&gt; q1 = Quat(equatorial=eq1)</span>
<span class="sd">      &gt;&gt;&gt; q2 = Quat(equatorial=eq2)</span>
<span class="sd">      &gt;&gt;&gt; dq = q1.dq(q2)</span>
<span class="sd">      &gt;&gt;&gt; dq.q</span>
<span class="sd">      array([[-0.02848482,  0.00774419,  0.03661687,  0.99889331],</span>
<span class="sd">             [ 0.15387087, -0.09527764,  0.12624189,  0.97535066],</span>
<span class="sd">             [-0.03970954, -0.01159734,  0.11488968,  0.99251651],</span>
<span class="sd">             [-0.14947438,  0.04195765, -0.06544431,  0.98570483],</span>
<span class="sd">             [-0.0393673 , -0.02604388, -0.045771  ,  0.99783613]])</span>

<span class="sd">    :param attitude: initialization attitude for quat</span>

<span class="sd">    ``attitude`` may be:</span>
<span class="sd">      * another Quat</span>
<span class="sd">      * a 4 element array (expects x,y,z,w quat form)</span>
<span class="sd">      * a 3 element array (expects ra,dec,roll in degrees)</span>
<span class="sd">      * a 3x3 transform/rotation matrix</span>

<span class="sd">    :param q: attitude as a quaternion.</span>

<span class="sd">    ``q`` must be an array with shape (4,) or (N, 4), with arbitrary N.</span>
<span class="sd">    The last axis corresponds to quaternion coordinates x, y, z, w.</span>
<span class="sd">    For example: (3, 2, 4) corresponds to a (3, 2) array of quaternions.</span>

<span class="sd">    :param equatorial: attitude in equatorial coordinates.</span>

<span class="sd">    ``q`` must be an array with shape (3,) or (N, 3), with arbitrary N.</span>
<span class="sd">    The last axis corresponds to equatorial coordinates ra, dec, roll.</span>
<span class="sd">    For example: (3, 2, 3) corresponds to a (3, 2) array of quaternions.</span>

<span class="sd">    :param transform: attitude as a 3x3 transform.</span>

<span class="sd">    ``q`` must be an array with shape (3, 3) or (N, 3, 3), with arbitrary N.</span>
<span class="sd">    The last two axes correspond to (3, 3) transformations.</span>
<span class="sd">    For example: (3, 2, 3, 3) corresponds to a (3, 2) array of quaternions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equatorial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># other data members that are set lazily.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ra0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roll0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equatorial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">npar</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">attitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">equatorial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">npar</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">npar</span><span class="si">}</span><span class="s1"> arguments passed to constructor that takes only one of&#39;</span>
                <span class="s1">&#39; attitude, transform, quaternion, equatorial.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># checks to see if we&#39;ve been passed a Quat</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attitude</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">attitude</span><span class="o">.</span><span class="n">q</span>
        <span class="k">elif</span> <span class="n">attitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check to see if it is a supported shape</span>
            <span class="n">attitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">attitude</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attitude</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">attitude</span>
            <span class="k">elif</span> <span class="n">attitude</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="n">attitude</span>
            <span class="k">elif</span> <span class="n">attitude</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                <span class="n">equatorial</span> <span class="o">=</span> <span class="n">attitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">attitude</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (shape </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;attitude argument</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2"> is not one of an allowed type:&quot;</span>
                    <span class="s2">&quot; Quat or array with shape (...,3), (...,4), or (..., 3, 3)&quot;</span><span class="p">)</span>

        <span class="c1"># checking correct shapes</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Creating a Quaternion from quaternion(s) &quot;</span>
                                <span class="s2">&quot;requires shape (..., 4), not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">elif</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Creating a Quaternion from quaternion(s) &quot;</span>
                                <span class="s2">&quot;requires shape (..., 3, 3), not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="k">elif</span> <span class="n">equatorial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">equatorial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">equatorial</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">equatorial</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">equatorial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Creating a Quaternion from ra, dec, roll &quot;</span>
                                <span class="s2">&quot;requires shape (..., 3), not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">equatorial</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equatorial</span> <span class="o">=</span> <span class="n">equatorial</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The shape of the multi-quaternion.</span>

<span class="sd">        For example, if the Quat is:</span>
<span class="sd">        - a single quaternion, then its shape is ().</span>
<span class="sd">        - a multi-quaternion with self.q.shape = (N, 4), then its shape is (N,)</span>

<span class="sd">        :returns: self.q.shape[:-1]</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve 4-vector of quaternion elements in [x, y, z, w] form</span>
<span class="sd">        or N x 4-vector if N &gt; 1.</span>

<span class="sd">        :rtype: numpy array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Figure out q from available values, doing nothing others are not defined</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial2quat</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform2quat</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,))</span>

    <span class="nd">@q</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of the 4 element quaternion vector</span>
<span class="sd">        May be 4 element list or array or N x 4 element array,</span>
<span class="sd">        where N can be an arbitrary shape. E.g.: (3,2,4) is allowed.</span>

<span class="sd">        :param q: list or array of normalized quaternion elements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Capture input shape sans 4-vector dimension</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Quaternions must be normalized so sum(q**2) == 1; use Quaternion.normalize&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="n">flip_q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">flip_q</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="n">flip_q</span><span class="p">]</span>
        <span class="c1"># Erase internal values of other representations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1"> q1=</span><span class="si">{:.8f}</span><span class="s1"> q2=</span><span class="si">{:.8f}</span><span class="s1"> q3=</span><span class="si">{:.8f}</span><span class="s1"> q4=</span><span class="si">{:.8f}</span><span class="s1">&gt;&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equatorial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve [RA, Dec, Roll]</span>

<span class="sd">        :rtype: numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quat2equatorial</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform2quat</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quat2equatorial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>

    <span class="nd">@equatorial</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">equatorial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equatorial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the value of the 3 element equatorial coordinate list [RA,Dec,Roll]</span>
<span class="sd">           expects values in degrees</span>
<span class="sd">           bounds are not checked</span>

<span class="sd">           :param equatorial: list or array [ RA, Dec, Roll] in degrees</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">equatorial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">equatorial</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">equatorial</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Capture input shape sans 3-vector dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">equatorial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve RA term from equatorial system in degrees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equatorial</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve Dec term from equatorial system in degrees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equatorial</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve Roll term from equatorial system in degrees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equatorial</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[()]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_zero</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a version of val that is between -180 &lt;= val &lt; 180</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="n">val</span><span class="p">[</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)[()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion RA in the range -180 &lt;= roll &lt; 180.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ra0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ra0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ra0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roll0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion roll in the range -180 &lt;= roll &lt; 180.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roll0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roll0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roll0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pitch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion pitch (same as -dec)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion yaw (same as ra0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the value of the 3x3 rotation/transform matrix</span>

<span class="sd">        :returns: 3x3 rotation/transform matrix</span>
<span class="sd">        :rtype: numpy array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quat2transform</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial2transform</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="nd">@transform</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of the 3x3 rotation/transform matrix</span>

<span class="sd">        :param t: 3x3 array/numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Capture input shape sans matrix dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equatorial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Quat object, possibly applying a method to self.q.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str or callable</span>
<span class="sd">            If string, can be &#39;replicate&#39;  or the name of a relevant</span>
<span class="sd">            `~numpy.ndarray` method. In the former case, a new Quat instance</span>
<span class="sd">            with unchanged internal data is created, while in the latter the</span>
<span class="sd">            method is applied to self.q.</span>
<span class="sd">            If a callable, it is directly applied to the above arrays.</span>
<span class="sd">            Examples: &#39;copy&#39;, &#39;__getitem__&#39;, &#39;reshape&#39;, `~numpy.broadcast_to`.</span>
<span class="sd">        args : tuple</span>
<span class="sd">            Any positional arguments for ``method``.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Any keyword arguments for ``method``.</span>


<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ::</span>

<span class="sd">            copy : ``_apply(&#39;copy&#39;)``</span>
<span class="sd">            reshape : ``_apply(&#39;reshape&#39;, new_shape)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
            <span class="n">apply_method</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">array</span><span class="p">:</span> <span class="n">method</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">apply_method</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">methodcaller</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Use a trick to temporarily make q into a stuctured array with 4</span>
        <span class="c1"># floats so that the shape applies to the 4-float item rather than</span>
        <span class="c1"># the full array (essentially removing the last dimension).</span>
        <span class="n">qsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="s1">&#39;4f8&#39;</span><span class="p">)]))</span>
        <span class="c1"># view() always leaves a single dimension at end so squeeze it.</span>
        <span class="n">qsa</span> <span class="o">=</span> <span class="n">qsa</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">apply_method</span><span class="p">(</span><span class="n">qsa</span><span class="p">)[</span><span class="s1">&#39;quat&#39;</span><span class="p">]</span>

        <span class="c1"># Get a new instance of our class and set its attributes directly.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;too many indices for array&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_quat2equatorial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine Right Ascension, Declination, and Roll for the quaternion</span>

<span class="sd">        :returns: N x (RA, Dec, Roll)</span>
<span class="sd">        :rtype: numpy array [ra,dec,roll]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># calculate direction cosine matrix elements from $quaternions</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">yn</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Due to numerical precision this can go negative.  Allow *slightly* negative</span>
        <span class="c1"># values but raise an exception otherwise.</span>
        <span class="n">one_minus_xn2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">one_minus_xn2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">one_minus_xn2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-12</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected negative norm: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">one_minus_xn2</span><span class="p">))</span>
            <span class="n">one_minus_xn2</span><span class="p">[</span><span class="n">one_minus_xn2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># ; calculate RA, Dec, Roll from cosine matrix elements</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">xa</span><span class="p">))</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">one_minus_xn2</span><span class="p">)))</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">zn</span><span class="p">))</span>
        <span class="c1"># all negative angles are incremented by 360,</span>
        <span class="c1"># the output is in the (0,360) interval instead of in (-180, 180)</span>
        <span class="n">ra</span><span class="p">[</span><span class="n">ra</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">ra</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="n">roll</span><span class="p">[</span><span class="n">roll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">roll</span><span class="p">[</span><span class="n">roll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="c1"># moveaxis in the following line is a &quot;transpose&quot;</span>
        <span class="c1"># from shape (3, N) to (N, 3), where N can be an arbitrary tuple</span>
        <span class="c1"># e.g. (3, 2, 5) -&gt; (2, 5, 3) (np.transpose would give (2, 3, 5))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">roll</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#  _quat2transform is largely from Enthought&#39;s quaternion.rotmat, though this math is</span>
<span class="c1">#  probably from Hamilton.</span>
<span class="c1">#  License included for completeness</span>
<span class="c1">#</span>
<span class="c1"># This software is OSI Certified Open Source Software.</span>
<span class="c1"># OSI Certified is a certification mark of the Open Source Initiative.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2006, Enthought, Inc.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1">#  * Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions and the following disclaimer.</span>
<span class="c1">#  * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#  * Neither the name of Enthought, Inc. nor the names of its contributors may</span>
<span class="c1">#    be used to endorse or promote products derived from this software without</span>
<span class="c1">#    specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="c1"># ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c1"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="c1"># ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c1"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="c1"># ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c1"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

    <span class="k">def</span> <span class="nf">_quat2transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a unit quaternion into its corresponding rotation/transform matrix.</span>

<span class="sd">        :returns: Nx3x3 transform matrix</span>
<span class="sd">        :rtype: numpy array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">xx2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">yy2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">zz2</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">xy2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">wz2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">zx2</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">wy2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">yz2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="n">wx2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">2.</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">zz2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span> <span class="o">-</span> <span class="n">wz2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zx2</span> <span class="o">+</span> <span class="n">wy2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span> <span class="o">+</span> <span class="n">wz2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">zz2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz2</span> <span class="o">-</span> <span class="n">wx2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zx2</span> <span class="o">-</span> <span class="n">wy2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz2</span> <span class="o">+</span> <span class="n">wx2</span>
        <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">yy2</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">_equatorial2quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return quaternion.</span>

<span class="sd">        :returns: quaternion</span>
<span class="sd">        :rtype: Quat</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform2quat</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_equatorial2transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the transform/rotation matrix from RA,Dec,Roll</span>

<span class="sd">        :returns: transform matrix</span>
<span class="sd">        :rtype: Nx3x3 numpy array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span>

        <span class="c1"># This is the transpose of the transformation matrix (related to translation</span>
        <span class="c1"># of original perl code</span>
        <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ca</span> <span class="o">*</span> <span class="n">cd</span><span class="p">,</span>                    <span class="n">sa</span> <span class="o">*</span> <span class="n">cd</span><span class="p">,</span>                  <span class="n">sd</span><span class="p">],</span>  <span class="c1"># noqa</span>
                         <span class="p">[</span><span class="o">-</span><span class="n">ca</span> <span class="o">*</span> <span class="n">sd</span> <span class="o">*</span> <span class="n">sr</span> <span class="o">-</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">cr</span><span class="p">,</span>   <span class="o">-</span><span class="n">sa</span> <span class="o">*</span> <span class="n">sd</span> <span class="o">*</span> <span class="n">sr</span> <span class="o">+</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cr</span><span class="p">,</span>   <span class="n">cd</span> <span class="o">*</span> <span class="n">sr</span><span class="p">],</span>  <span class="c1"># noqa</span>
                         <span class="p">[</span><span class="o">-</span><span class="n">ca</span> <span class="o">*</span> <span class="n">sd</span> <span class="o">*</span> <span class="n">cr</span> <span class="o">+</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">sr</span><span class="p">,</span>   <span class="o">-</span><span class="n">sa</span> <span class="o">*</span> <span class="n">sd</span> <span class="o">*</span> <span class="n">cr</span> <span class="o">-</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">sr</span><span class="p">,</span>   <span class="n">cd</span> <span class="o">*</span> <span class="n">cr</span><span class="p">]])</span>  <span class="c1"># noqa</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">rmat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transform2quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct quaternions from the transform/rotation matrices</span>

<span class="sd">        :returns: quaternions formed from transform matrices</span>
<span class="sd">        :rtype: numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span>
        <span class="k">if</span> <span class="n">T</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="mf">1.0</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="mf">1.0</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="mf">1.0</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

        <span class="n">half_rt_q_max</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">poss_quat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">((</span><span class="mi">4</span><span class="p">,)</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)))</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">half_rt_q_max</span>
        <span class="n">poss_quat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">half_rt_q_max</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">poss_quat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="n">half_rt_q_max</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">poss_quat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="n">half_rt_q_max</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">poss_quat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                 <span class="n">half_rt_q_max</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">max_match</span> <span class="o">=</span> <span class="n">max_idx</span> <span class="o">==</span> <span class="n">idx</span>
            <span class="n">q</span><span class="p">[</span><span class="n">max_match</span><span class="p">]</span> <span class="o">=</span> <span class="n">poss_quat</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">max_match</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">q</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quat2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Divide one quaternion by another (or divide N quats by N quats).</span>

<span class="sd">        Example usage::</span>

<span class="sd">         &gt;&gt;&gt; q1 = Quat((20,30,40))</span>
<span class="sd">         &gt;&gt;&gt; q2 = Quat((30,40,50))</span>
<span class="sd">         &gt;&gt;&gt; q = q1 / q2</span>

<span class="sd">        Performs the operation as q1 * inverse(q2) which is equivalent to</span>
<span class="sd">        the inverse(q2) transform followed by the q1 transform.  See the __mul__</span>
<span class="sd">        operator help for more explanation on composing quaternions.</span>

<span class="sd">        :returns: product q1 * inverse q2</span>
<span class="sd">        :rtype: Quat</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">quat2</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

    <span class="fm">__truediv__</span> <span class="o">=</span> <span class="n">__div__</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quat2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiply quaternion by another (or multiply N quats by N quats).</span>

<span class="sd">        Quaternion composition as a multiplication q = q1 * q2 is equivalent to</span>
<span class="sd">        applying the q2 transform followed by the q1 transform.  Another way to</span>
<span class="sd">        express this is::</span>

<span class="sd">          q = Quat(q1.transform @ q2.transform)</span>

<span class="sd">        Example usage::</span>

<span class="sd">          &gt;&gt;&gt; q1 = Quat((20,30,0))</span>
<span class="sd">          &gt;&gt;&gt; q2 = Quat((0,0,40))</span>
<span class="sd">          &gt;&gt;&gt; (q1 * q2).equatorial</span>
<span class="sd">          array([20., 30., 40.])</span>

<span class="sd">        This example first rolls about X by 40 degrees, then rotates that rolled frame</span>
<span class="sd">        to RA=20 and Dec=30.  Doing the composition in the other order does a roll about</span>
<span class="sd">        (the original) X-axis of the (RA, Dec) = (20, 30) frame, yielding a non-intuitive</span>
<span class="sd">        though correct result::</span>

<span class="sd">          &gt;&gt;&gt; (q2 * q1).equatorial</span>
<span class="sd">          array([ 353.37684725,   34.98868888,   47.499696  ])</span>

<span class="sd">        :returns: product q1 * q2</span>
<span class="sd">        :rtype: Quat</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">quat2</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">q2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">mult</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># noqa</span>
        <span class="n">mult</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># noqa</span>
        <span class="n">mult</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># noqa</span>
        <span class="n">mult</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># noqa</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">quat2</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">else</span> <span class="n">quat2</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">Quat</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">mult</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

<div class="viewcode-block" id="Quat.inv"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat.inv">[docs]</a>    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert the quaternion.</span>

<span class="sd">        :returns: inverted quaternion</span>
<span class="sd">        :rtype: Quat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">Quat</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="Quat.dq"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat.dq">[docs]</a>    <span class="k">def</span> <span class="nf">dq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a delta quaternion ``dq`` such that ``q2 = self * dq``.</span>
<span class="sd">        I works with any argument that instantiates a ``Quat`` object.</span>

<span class="sd">        This method returns the delta quaternion which represents the transformation</span>
<span class="sd">        from the frame of this quaternion (``self``) to ``q2``.</span>

<span class="sd">          q = Quat(q1.transform @ q2.transform)</span>

<span class="sd">        Example usage::</span>

<span class="sd">          &gt;&gt;&gt; q1 = Quat((20, 30, 0))</span>
<span class="sd">          &gt;&gt;&gt; q2 = Quat((20, 30.1, 1))</span>
<span class="sd">          &gt;&gt;&gt; dq = q1.dq(q2)</span>
<span class="sd">          &gt;&gt;&gt; dq.equatorial</span>
<span class="sd">          array([  1.79974166e-15,   1.00000000e-01,   1.00000000e+00])</span>

<span class="sd">        :param: q2 Quat or array</span>

<span class="sd">        ``q2`` must have the same shape as self.</span>

<span class="sd">        :returns: Quat</span>
<span class="sd">        :rtype: numpy array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">q2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">q2</span></div>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c1"># this method is called by the pickle module when unpickling an instance of this class.</span>
        <span class="c1"># It receives the dictionary of the unpickled state and must update the __dict__ of this</span>
        <span class="c1"># instance. This is the place where we &quot;upgrade&quot; pickled instances of earlier versions of</span>
        <span class="c1"># the class.</span>
        <span class="k">if</span> <span class="s1">&#39;_shape&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="c1"># if _shape is not there, then this is a non-vectorized Quat (versions before 3.5.0).</span>
            <span class="c1"># Non-vectorized quaternions were basically scalars, with shape ().</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="Quat.rotate_x_to_vec"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat.rotate_x_to_vec">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rotate_x_to_vec</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;radec&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate quaternion that rotates X-axis into ``vec``.</span>

<span class="sd">        The ``method`` parameter can take one of three values: &quot;shortest&quot;,</span>
<span class="sd">        &quot;keep_z&quot;, or &quot;radec&quot; (default).  The &quot;shortest&quot; method takes the shortest</span>
<span class="sd">        path between the two vectors.  The &quot;radec&quot; method does the transformation</span>
<span class="sd">        as the corresponding (RA, Dec, Roll=0) attitude.  The &quot;keep_z&quot; method does</span>
<span class="sd">        a roll about X-axis (followed by the &quot;shortest&quot; path) such that the</span>
<span class="sd">        transformed Z-axis is in the original X-Z plane.  In equations::</span>

<span class="sd">        T: &quot;shortest&quot; quaternion taking X-axis to vec</span>
<span class="sd">        Rx(theta): Rotation by theta about X-axis = [[1,0,0], [0,c,s], [0,-s,c]]</span>
<span class="sd">        Z: Z-axis [0,0,1]</span>

<span class="sd">        [T * Rx(theta) * Z]_y = 0</span>
<span class="sd">        T[1,1] * sin(theta) + T[1,2]*cos(theta) = 0</span>
<span class="sd">        theta = atan2(T[1,2], T[1,1])</span>

<span class="sd">        :param vec: Input 3-vector</span>
<span class="sd">        :param method: method for determining path (shortest|keep_z|radec)</span>
<span class="sd">        :returns: Quaternion object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;vec must be a single 3-vector&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;shortest&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_z&quot;</span><span class="p">):</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-8</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1e-7</span><span class="p">]))</span>
                <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vec</span><span class="p">))</span>
            <span class="n">sin_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cos_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_a</span><span class="p">,</span>
                     <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_a</span><span class="p">,</span>
                     <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_a</span><span class="p">,</span>
                     <span class="n">cos_a</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;keep_z&quot;</span><span class="p">:</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">transform</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">qroll</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">qroll</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;radec&quot;</span><span class="p">:</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;method must be one of &quot;shortest&quot;, &quot;keep_z&quot; or &quot;radec&quot;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="Quat.rotate_about_vec"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat.rotate_about_vec">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_about_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate self about a 3-vector</span>

<span class="sd">        :param vec: 3-element array-like</span>
<span class="sd">            Single vector to rotate about</span>
<span class="sd">        :param alpha: float</span>
<span class="sd">            Angle to rotate by in degrees</span>

<span class="sd">        :returns: Quat</span>
<span class="sd">            Rotated attitude</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: fix these limitations on shapes, starting with quat multiplication</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;quaternion must be a scalar&#39;</span><span class="p">)</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;vec must be a single 3-vector&#39;</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;alpha must be a scalar&#39;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">sin_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">dq</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">([</span><span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cos_alpha</span><span class="p">])</span>
        <span class="n">att_out</span> <span class="o">=</span> <span class="n">dq</span> <span class="o">*</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">att_out</span></div>

<div class="viewcode-block" id="Quat.from_attitude"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.Quat.from_attitude">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_attitude</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">att</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initial Quat from attitude(s)</span>

<span class="sd">        This allows initialization from several possibilities that are less</span>
<span class="sd">        strict than the normal initializer:</span>
<span class="sd">        - Quat already (returns same)</span>
<span class="sd">        - Input that works with Quat already</span>
<span class="sd">        - Input that initializes a float ndarray which has shape[-1] == 3 or 4</span>
<span class="sd">        - Input that initializes an object ndarray where each element inits Quat,</span>
<span class="sd">        e.g. a list of Quat</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        att : Quaternion-like</span>
<span class="sd">            Attitude(s)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Quat</span>
<span class="sd">            Attitude(s) as a Quat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">att</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Input that works with Quat already</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">att</span>

        <span class="c1"># Input that initializes a float ndarray which has shape[-1] == 3 or 4</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">att_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">att_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">att_array</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">att_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">equatorial</span><span class="o">=</span><span class="n">att_array</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Float input must be a Nx3 or Nx4 array&quot;</span><span class="p">)</span>

        <span class="c1"># Input that initializes an object ndarray where each element inits Quat,</span>
        <span class="c1"># e.g. a list of Quat</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">att_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">att_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                <span class="n">qs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">q</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Quat</span><span class="p">)</span> <span class="k">else</span> <span class="bp">cls</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">att_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,))</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to initialize </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">att</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../module.html#Quaternion.Quaternion.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a 4 (or Nx4) element array/list/numpy.array for use as a quaternion</span>

<span class="sd">    :param array: 4 or Nx4 element list/array</span>
<span class="sd">    :returns: normalized array</span>
<span class="sd">    :rtype: numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">quat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">quat</span> <span class="o">*</span> <span class="n">quat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, Jean Connelly, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.1.2. &nbsp;
  </p>
</footer>
  </body>
</html>